/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Kotlin application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.5/userguide/building_java_projects.html
 */
buildscript {
  ext.kotlin_version = "1.7.0"

  dependencies {
    classpath "com.google.protobuf:protobuf-gradle-plugin:0.8.18"
  }
}

plugins {
    // Apply the org.jetbrains.kotlin.jvm Plugin to add support for Kotlin.
    id 'org.jetbrains.kotlin.jvm' version '1.7.0'

    id 'application'

    id "com.github.johnrengelman.shadow" version "7.0.0"

    // id "nu.studer.jooq" version "7.1.1"

    id "java"
}

apply plugin: "kotlin"
apply plugin: "com.google.protobuf"

repositories {
    maven {
        url "https://plugins.gradle.org/m2/"
    }
    
    mavenCentral()
    mavenLocal()
}

version = "0.0.1"
ext {
  vertxVersion = "4.3.4"
  protoVersion = "3.21.1"
  grpcVersion = "1.49.2"
  // vertxGrpcVersion = "4.3.1"
}
def mainVerticleName = "golf.handicap.vertx.MainVerticle"
def launcherClassName = "io.vertx.core.Launcher"
def junitJupiterVersion = "5.7.0"
def watchForChange = "src/main/**/*"
def doOnChange = "${projectDir}/gradlew classes"
def OS = System.getProperty("os.name").toLowerCase();
def jooqClasspath
def javaTargetVersion = 11
def useHandicap = System.getenv("USE_HANDICAP");

application {
  getMainClass().set(launcherClassName)
}

jooq {
  version = "3.17.5"
  edition = nu.studer.gradle.jooq.JooqEdition.OSS
}

task copyDatabaseConfig(type: Copy) {
    // from("src/main/resources/database_config.json") 
    // into new File("build", "resources/main")
    dependsOn gradle.includedBuild("generate").task(":build")
}
/*
  Using a java class to generate jooq objects - allows for multiple db's - see ./generate directory
  Composite build - implementation("dmo.fs.utils:generate:0.0.1") - this avoids the circular dependancy error
*/
task jooqGenerate(type: JavaExec) {
  group "Execution"
  doFirst {
    classpath = sourceSets.main.runtimeClasspath
  }
  
  environment.remove("DEFAULT_DB")
  environment "VERTXWEB_ENVIRONMENT", "dev"
  mainClass = "dmo.fs.utils.JooqGenerate"
  args = ["dev"]
  dependsOn copyDatabaseConfig
}



run {
  doFirst {
     if (System.getProperty("DEBUG", "false") == "true") {
        debug = "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
    }

    environment "VERTXWEB_ENVIRONMENT", "dev"

    args = ['run', mainVerticleName, "--redeploy=$watchForChange", "--launcher-class=$launcherClassName", 
      "--on-redeploy=$doOnChange", "--conf=src/main/resources/application-conf.json",
      "--java-opts=-Dvertx.disableFileCaching=true", "-PcompileOnly", debug]
  }
  if (project.hasProperty("compileOnly")) {
    dependsOn jooqGenerate
  }
}

kotlin {
  // change if out of memory
  kotlinDaemonJvmArgs = ["-Xmx512m", "-Xms256m", "-XX:+UseParallelGC"]
}
compileKotlin {
  kotlinOptions.jvmTarget = javaTargetVersion
  // if (project.hasProperty("compileOnly")) {
    dependsOn jooqGenerate
  // }
}

sourceCompatibility = "11"
// The standard protobuf block, same as normal gRPC Java projects
protobuf {
  protoc { artifact = "com.google.protobuf:protoc:${protoVersion}" }
    plugins {
      grpc { artifact = "io.grpc:protoc-gen-grpc-java:${grpcVersion}" }
      vertx {
        artifact = "io.vertx:vertx-grpc-protoc-plugin"
      }
    }
    generateProtoTasks {
      all()*.plugins { grpc {} }
    }
}

dependencies {
    implementation(platform("io.vertx:vertx-stack-depchain:$vertxVersion"))
    implementation("io.vertx:vertx-core:$vertxVersion")
    implementation("io.vertx:vertx-rx-java3:$vertxVersion")
    implementation("io.vertx:vertx-config:$vertxVersion")
    implementation("io.vertx:vertx-web:$vertxVersion")
    implementation("io.vertx:vertx-lang-kotlin")
    implementation("io.vertx:vertx-lang-kotlin-coroutines")
    implementation "io.vertx:vertx-web-api-contract:$vertxVersion"
    implementation("io.vertx:vertx-jdbc-client:$vertxVersion")
    implementation("io.vertx:vertx-web-templ-thymeleaf:$vertxVersion")
    implementation("io.vertx:vertx-grpc")
    implementation("io.vertx:vertx-grpc-client:$vertxVersion")
    implementation("org.slf4j:slf4j-jcl:1.7.36")
    implementation("io.agroal:agroal-pool:2.0")
    implementation("org.xerial:sqlite-jdbc:3.31.1")
    implementation("io.vertx:vertx-mysql-client:$vertxVersion")
    implementation("io.vertx:vertx-pg-client:$vertxVersion")
    // implementation("mysql:mysql-connector-java:8.0.31")
    // implementation group: 'mysql', name: 'mysql-connector-java', version: '8.0.31'
    implementation("org.mariadb.jdbc:mariadb-java-client:3.0.8")
    implementation("org.jooq:jooq:3.17.5")
    implementation("org.jooq:jooq-codegen-maven:3.17.5")
    implementation("org.jooq:jooq-meta:3.17.5")
    implementation("javax.annotation:javax.annotation-api:1.3.2")
    implementation("com.google.guava:guava:31.1-jre")

    // runtimeOnly("org.jetbrains.kotlinx:kotlinx-coroutines-rx3:1.6.4")

    testImplementation("io.vertx:vertx-junit5:$vertxVersion")
    testImplementation("org.junit.jupiter:junit-jupiter:$junitJupiterVersion")
    testImplementation("junit:junit:4.13.2")

    implementation("dmo.fs.utils:generate:0.0.1")
}

shadowJar {
  classifier = "fat"

  mergeServiceFiles {
    include "META-INF/services/io.vertx.core.spi.VerticleFactory"
  }

  manifest{
    attributes 'Main-Verticle': mainVerticleName
  }
}

test {
    // Use junit platform for unit tests
    environment "VERTXWEB_ENVIRONMENT", "test"
    useJUnitPlatform()
    testLogging {
        events "PASSED", "FAILED", "SKIPPED"
    }
}
